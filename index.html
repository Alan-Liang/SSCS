<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>SSCS | KEEER</title>
<link href="./gs.css" rel="stylesheet" type="text/css" />
<style>
body{
	background:#eef;
	font-family:Consolas;
}
#status{
	font-weight:bold;
}
#clog{
	width:100%;
}
</style>
</head>

<body>
Manager | SSCS | KEEER
<hr />
Port:<input id="port" value="8080" />
<br />
regCode:<input id="regcode" value="[]" />
<br />
<button id="savecfg" class="blue">Save</button>
<hr />
Status:<a id="status">Pending...</a>
<br />
<button id="start" class="green">Start</button>
<button id="stop" class="red">Stop</button>
<hr />
<textarea readonly id="clog"></textarea>

<script>
var $=function(a){return document.getElementById(a);};

var savecfg=$("savecfg");
var startsvc=$("start");
var stopsvc=$("stop");

var statusa=$("status");

var port=$("port");
var rc=$("regcode");
var clogi=$("clog");

var http=require("http");
var fs=require("fs");
var mime=require('mime');
var url=require('url');
var vurl=require('./vurl');

var chistory={};

var listeningFunc=function(req,resp){
	// Parse the request containing file name
	var pathname = url.parse(req.url).pathname.substr(1);
	if(cache[pathname]){
		var type=mime.lookup(pathname.substr(1));
		resp.writeHead(200, {'Content-Type':type});	
		resp.write(cache[pathname]);
		resp.end();
		return;
	}
	if(vurl.query(pathname)){
		try{
			(vurl.query(pathname))(req,resp);
			return;
		}catch(e){
			clog("Error executing "+pathname+" : "+e);
			resp.writeHead(501, {'Content-Type':'text/plain'});	
			resp.end();
			return;
		}
	}
};

var cache={};
var server;

function clog(str){
	var time=new Date().toLocaleString();
	console.log("["+time+"] "+str+"\n");
	clogi.innerHTML+=("["+time+"] "+str+"\n");
};

savecfg.onclick=function(){
	try{
		fs.writeFileSync("config.json", JSON.stringify({"port":parseInt(port.value),"regCode":rc.value}));
	}catch(e){
		clog("Error writing config file: "+e);
		return;
	}
	clog("Config file written.");
};

startsvc.onclick=function(){
	if(!server){
		try{
			server=http.createServer(listeningFunc);
			server.listen(parseInt(port.value));
		}catch(e){
			clog("Error listening on "+port.value+": "+e);
			statusa.innerHTML="Stopped";
			server=undefined;
			return;
		}
		clog("Server started, listening on "+port.value+".");
		statusa.innerHTML="Started";
	}
};

stopsvc.onclick=function(){
	if(server){
		try{
			server.close();
		}catch(e){
			clog("Error closing: "+e);
			return;
		}
		clog("Server stopped.");
		statusa.innerHTML="Stopped";
		server=undefined;
	}
};


var cfg;
try{
	cfg=fs.readFileSync("config.json");
	cfg=JSON.parse(cfg);
	port.value=cfg.port?cfg.port:"";
	rc.value=cfg.regCode?cfg.regCode:"";
}catch(e){
	clog("Error reading config: "+e);
}

var hist;
try{
	hist=fs.readFileSync("history.json");
	hist=JSON.parse(hist);
	chistory=hist?hist:{};
}catch(e){
	clog("Error reading history: "+e);
	chistory={};
	for(var i=0;i<eval(rc.value).length;i++){
		chistory[eval(rc.value)[i]]=[];
	}
}

startsvc.onclick();

var loadpages=["chat.html","gs.css"];
for(var i=0;i<loadpages.length;i++){
	try{
		var page=fs.readFileSync(loadpages[i]);
		cache[loadpages[i]]=page;
	}catch(e){
		clog("Error reading file "+loadpages[i]+" : "+e);
	}
}

function pendReq(req){
    var params = url.parse(req.url,true).query;
	for(var i=0;i<eval(rc.value).length;i++)
		if(params["rc"]==eval(rc.value)[i])return eval(rc.value)[i];
	return false;
}

//add listening functions
vurl.add={path:"webapi/history",func:function(req,resp){
	var trc;
	if((trc=pendReq(req))!=false){
		resp.writeHead(200, {'Content-Type':'application/json'});
		resp.write(JSON.stringify({chistory:chistory[trc]}));
		resp.end();
		return;
	}
	resp.writeHead(403, {'Content-Type':'text/plain'});
	resp.write("403 unauthorized");
	resp.end();
}};
vurl.add={path:"webapi/new",func:function(req,resp){
	var trc;
	if((trc=pendReq(req))!=false){
		var params = url.parse(req.url,true).query;
		if(params["last"]){
			resp.writeHead(200, {'Content-Type':'application/json'});
			resp.write("{\"nw\":[");
			for(var i=chistory[trc].length-1;i>=0;i--){
				if(chistory[trc][i].id==params.last){
					for(var c=i;c<chistory[trc].length;c++){
						resp.write(JSON.stringify(chistory[trc][c]));
						if((c+1)<chistory[trc].length)resp.write(",");
					}
				}
			}
			resp.write("]}");
			resp.end();
			return;
		}
		resp.writeHead(400, {'Content-Type':'application/json'});
		resp.write("bad parameter");
		resp.end();
		return;
	}
	resp.writeHead(403, {'Content-Type':'text/plain'});
	resp.write("403 unauthorized");
	resp.end();
}};
vurl.add={path:"webapi/add",func:function(req,resp){
	var trc;
	if((trc=pendReq(req))!=false){
		var postData="";
		req.setEncoding("utf8");
		req.addListener("data", function(postDataChunk) {
			postData += postDataChunk;
		});
		req.addListener("end", function() {
			try{
				var params = JSON.parse(postData);
				if(params["time"]&&params["user"]&&params["text"]){
					chistory[trc].push({
						time:decodeURI(params.time),
						user:decodeURI(params.user),
						text:decodeURI(params.text),
						id:chistory[trc].length
						});
					try{
						fs.writeFileSync("./history.json",JSON.stringify(chistory));
					}catch(e){
						clog("Error writing history file :"+e);
					}
					resp.writeHead(200, {'Content-Type':'application/json'});
					resp.write("{status:"+(chistory[trc].length-1)+"}");
					resp.write(postData);
				}
				else{
					resp.writeHead(200, {'Content-Type':'application/json'});
					resp.write("{status:-1}");
				}
				resp.end();
			}catch(e){
				resp.writeHead(501, {'Content-Type':'application/json'});
				clog("Error adding message :"+e);
				resp.end();
				}
		});
	}else{
		resp.writeHead(403, {'Content-Type':'text/plain'});
		resp.write("403 unauthorized");
		resp.end();
	}
}};
var loginp;
try{
	loginp=fs.readFileSync("main.html");
}catch(e){
	clog("Error reading file main.html : "+e);
}
vurl.add={path:"",func:function(req,resp){
	resp.writeHead(200, {'Content-Type':'text/html'});
	resp.write(loginp);
	resp.end();
}};


vurl.add={path:"webapi/login",func:function(req,resp){
	var trc;
	if((trc=pendReq(req))!=false){
		var params = url.parse(req.url,true).query;
		resp.writeHead(302, {'Location':'/chat.html?rc='+encodeURI(trc)+'&uname='+encodeURI(params.uname)});
		resp.end();
		return;
	}
	resp.writeHead(302, {'Location':'/'});
	resp.write("Unauthorized");
	resp.end();
}};
</script>
</body>
</html>
