<!DOCTYPE html>
<html>
<head>
<title>{{title}}</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="./mdc.css" rel="stylesheet" type="text/css" />
<style>
/* commons */
.width-100{
	width:100%;
}
.no-padding{
	padding:0;
	min-height:0;
}
.align-center{
	text-align:center;
}
.align-right{
	text-align:right;
}
[hidden], .hidden{
	display:none;
}
.atme{
	font-weight:bold;
	color:#e00;
}

body{
	margin:0;
}
#header-pad{
	height:64px;
}
#appbar{
	//todo
}
#messages{
	margin:10px;
	margin-bottom:64px;
}
.message{
	margin-top:10px;
}
.mdc-card{
	padding:5px;
}
#sendbox{
	position:fixed;
	bottom:0;
	background:#fff;
}
.message-header{
	display:table;
	width:100%;
}
.message-head,.message-actions{
	display:table-cell;
}
.message-actions{
	width:150px;
}
</style>
<script language="x/template" id="templ">
<div class="message mdc-card mdc-typography--subtitle1" id="msg_{{id}}">
  <div class="message-header">
    <span class="message-head">[{{time}}] {{user}}:</span>
    <div class="mdc-card__actions no-padding align-right message-actions">
      <div class="mdc-card__action-buttons">
        <a data-mdc-auto-init="MDCRipple" href="#msg_{{id}}" class="mdc-button mdc-card__action mdc-card__action--button">PermaLink-#{{id}}</a>
      </div>
    </div>
  </div>
  {{text}}
</div>
</script>
<script type="text/javascript" src="https://res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/vconsole/3.0.0/vconsole.min.js"></script>
</head>
<body>
<header class="mdc-top-app-bar mdc-elevation--z5 {{hideAppBar}}" id="appbar" data-mdc-auto-init="MDCTopAppBar">
  <div class="mdc-top-app-bar__row">
    <section class="mdc-top-app-bar__section">
      <span class="mdc-top-app-bar__title align-center width-100">{{title}}</span>
    </section>
  </div>
</header>
<div id="header-pad"></div>
<div id="messages"></div>
<div id="sendbox" data-mdc-auto-init="MDCTextField" class="mdc-text-field mdc-text-field--full-width width-100 mdc-text-field--with-trailing-icon">
  <input type="text" id="msgbox" class="mdc-text-field__input">
  <label for="msg" class="mdc-floating-label">Message to send...</label>
  <i class="mdc-text-field__icon" tabindex="0" id="sendbtn" role="button">Send</i>
  <div class="mdc-line-ripple"></div>
</div>
<script src="./mdc.js"></script>
<script>mdc.autoInit();var vc=new VConsole();</script>
<script type="text/javascript">
var $=function(a){return document.getElementById(a);};
function debug(str){
	var debug=false;
	if(debug)alert(str);
}

var templ=$("templ").innerHTML;
var chatroom=$("messages");
var msgbox=$("msgbox");
var sendbtn=$("sendbtn");

var rc;
try{
	var a=(window.location.search.substr(/rc=/.exec(window.location.search).index+3));
	var b=/&/.exec(a);
	b=b?b.index:undefined;
	a=a.substr(0,b);
	rc=a?a:prompt("regCode:");
}catch(e){}
var user;
try{
	var a=(window.location.search.substr(/uname=/.exec(window.location.search).index+6));
	var b=/&/.exec(a);
	b=b?b.index:undefined;
	a=a.substr(0,b);
	user=a?a:prompt("username:");
}catch(e){}
var last=-1;
function tpl(chatmsg,str,idn){
	var st=/{{[a-zA-Z]*}}/gi;
	var res="";
	var comp;
	var last=0;
	var flag=false;
	while(comp=st.exec(str)){
		res+=str.substring(last,comp.index);
		flag=true;
		last=comp.index+comp[0].length;
		var pps=str.substring(comp.index+2,last-2);
		var val;
		if(pps=="time")chatmsg[idn][pps]=new Date(chatmsg[idn][pps]).toString();
		if(pps=="text" && (chatmsg[idn][pps].indexOf("@"+user)>-1))
			chatmsg[idn][pps]="<font class=\"atme\">"+chatmsg[idn][pps]+"</font>";
/*		if(pps=="text"&&/\[Code:.*\]/.test(chatmsg[idn][pps])){
			/\[Code:.*\]/gi.exec(chatmsg[idn][pps]).index;
		}*/
		if((val=chatmsg[idn][pps])!=undefined)res+=val;
		else res+=("{{"+pps+"}}");
	}
	res+=str.substring(last,str.length);
	return res;
}
var newdiv;
function loadmsg(chatmsg,clearflag){
	if(clearflag)chatroom.innerHTML="";
	for(var i=0;i<chatmsg.length;i++){
		newdiv=document.createElement("div");
		newdiv.className="message-wrapper";
		newdiv.innerHTML=tpl(chatmsg,templ,i);
		chatroom.appendChild(newdiv);
		if(("#msg_"+chatmsg[i].id)==location.hash){
			var off=newdiv.offsetTop;
			setTimeout(function(){
				window.scrollTo(0,off);
			},10);
		}
	}
	debug(templ);
	var a=chatmsg[chatmsg.length-1];
	var b=a?a:{id:-1};
	return b.id;
}

sendbtn.onclick=function(){
	if(!(msgbox.value&&(msgbox.value!="")))return;
	httppost("/webapi/add?rc="+rc,
		{"time":new Date(),
			"user":user,
			"text":msgbox.value},
		function(){});
	msgbox.value="";
	msgbox.focus();
};

msgbox.onkeypress=function(e){
	if(e.charCode==13)sendbtn.onclick();
};

function httpget(path,callback){
	var xhr=new XMLHttpRequest();
	xhr.open('get',path);
	xhr.onreadystatechange=function() {
	    if(this.readyState!=4) return;
		callback(xhr.status,xhr.response);
	}
	xhr.send();
	return;
}
function httppost(path,podata,callback){
	var xhrpost=new XMLHttpRequest();
	xhrpost.open('post',path);
	xhrpost.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
	xhrpost.send(JSON.stringify(podata));
	xhrpost.onreadystatechange=function() {
	    if(this.readyState!=4) return;
    	if(xhrpost.status==200) { // OK, New data
			callback(xhrpost.response);
    	}
	}
	try{xhrpost.send();}catch(e){console.log(e);}
}

httpget("/webapi/history?rc="+rc,function(stat,resp){
	if(stat!=200)return;
	try{
		last=loadmsg(JSON.parse(resp).history);
		mdc.autoInit();
		//window.scrollTo(4294967296,4294967296);
	}catch(e){}
});
setInterval(function(){
	httpget("/webapi/new?rc="+rc+"&last="+(last+1),function(stat,resp){
		if(stat!=200)return;
		try{
			var a=loadmsg(JSON.parse(resp).news);
			last=(a!=-1)?a:last;
			if(a!=-1){
				//todo: new msg!
				mdc.autoInit();
			}//window.scrollTo(4294967296,4294967296);
		}catch(e){}
	});
},1000);
</script>
</body>
</html>